//@version=6
indicator("Zay Gwet Alert (Burmese)", overlay=true, max_lines_count=500, max_labels_count=500)

// ================= INPUTS =================
openHour    = input.int(9, "Market Open Hour", minval=0, maxval=23)
openMin     = input.int(30, "Market Open Minute", minval=0, maxval=59)
orbMinutes  = input.int(15, "ORB Duration (minutes)", minval=1)
emaLen      = input.int(9, "EMA Length")

showORB     = input.bool(true, "Show ORB Lines")

// ================= COLOR SETTINGS =================
orbHighColor    = input.color(color.green, "ORB High Line Color")
orbLowColor     = input.color(color.red, "ORB Low Line Color")
buySignalColor  = input.color(color.green, "Buy Signal Color")
sellSignalColor = input.color(color.red, "Sell Signal Color")

// ================= SIZE SETTINGS =================
signalSizeConst = size.normal

// ================= NEW INPUTS FOR TP/SL =================
tpMultiplier = input.float(2.0, "Take Profit Multiplier (R:R)", minval=0.5, step=0.5)
slPercent    = input.float(1.0, "Stop Loss % from Entry", minval=0.1, step=0.1)

showTPSL     = input.bool(true, "Show TP/SL Levels")
showEntry    = input.bool(true, "Show Entry Conditions")

// ================= TIME / ORB =================
_y = year(time)
_m = month(time)
_d = dayofmonth(time)
start_time = timestamp(_y, _m, _d, openHour, openMin)
end_time   = start_time + orbMinutes * 60000

var float tempHigh = na
var float tempLow  = na
var float orbHigh  = na
var float orbLow   = na

var line orbHighLine = na
var line orbLowLine  = na

newDay = dayofmonth != dayofmonth[1]
if newDay
    tempHigh := na
    tempLow  := na
    orbHigh  := na
    orbLow   := na
    if not na(orbHighLine)
        line.delete(orbHighLine)
        orbHighLine := na
    if not na(orbLowLine)
        line.delete(orbLowLine)
        orbLowLine := na

sessionActive   = time >= start_time and time < end_time
sessionStartBar = sessionActive and not sessionActive[1]
sessionEndBar   = time >= end_time and time[1] < end_time

if sessionStartBar
    tempHigh := high
    tempLow  := low
else if sessionActive
    tempHigh := math.max(nz(tempHigh, high), high)
    tempLow  := math.min(nz(tempLow, low), low)

if sessionEndBar
    orbHigh := tempHigh
    orbLow  := tempLow
    if not na(orbHighLine)
        line.delete(orbHighLine)
    if not na(orbLowLine)
        line.delete(orbLowLine)
    orbHighLine := line.new(bar_index, orbHigh, bar_index + 1, orbHigh, extend=extend.right, color=orbHighColor, width=2)
    orbLowLine  := line.new(bar_index, orbLow,  bar_index + 1, orbLow,  extend=extend.right, color=orbLowColor, width=2)

// ================= SIGNAL LOGIC =================
hasOrb = not na(orbHigh) and not na(orbLow)

crossAboveORBHigh = ta.crossover(close, orbHigh) and not na(orbHigh)
crossBelowORBLow  = ta.crossunder(close, orbLow)  and not na(orbLow)

// ================= EMA9 =================
ema9    = ta.ema(close, emaLen)
crossAboveEMA  = ta.crossover(close, ema9)
crossBelowEMA  = ta.crossunder(close, ema9)

// ================= EMA TREND ANALYSIS =================
// Multiple EMAs for trend strength
ema20 = ta.ema(close, 20)
ema50 = ta.ema(close, 50)
ema100 = ta.ema(close, 100)
ema200 = ta.ema(close, 200)

// Determine trend strength
priceAboveEMA9   = close > ema9
priceAboveEMA20  = close > ema20
priceAboveEMA50  = close > ema50
priceAboveEMA100 = close > ema100
priceAboveEMA200 = close > ema200

bullishCount = (priceAboveEMA9 ? 1 : 0) + (priceAboveEMA20 ? 1 : 0) + (priceAboveEMA50 ? 1 : 0) + (priceAboveEMA100 ? 1 : 0) + (priceAboveEMA200 ? 1 : 0)

emaTrend = bullishCount == 5 ? "Strong Bullish" : 
           bullishCount == 4 ? "Bullish" :
           bullishCount == 3 ? "Mixed" :
           bullishCount == 2 ? "Mixed" :
           bullishCount == 1 ? "Bearish" : "Strong Bearish"

emaTrendColor = bullishCount >= 4 ? color.new(color.green, 0) :      bullishCount == 3 or bullishCount == 2 ? color.new(color.orange, 0) :              color.new(color.red, 0)// ================= TP/SL CALCULATION =================
var float buyEntry = na
var float buyTP = na
var float buySL = na

var float sellEntry = na
var float sellTP = na
var float sellSL = na

// Buy Signal (ORB High Break or EMA Cross Above)
buySignal = crossAboveORBHigh or crossAboveEMA

if buySignal
    buyEntry := close
    buySL := buyEntry * (1 - slPercent / 100)
    slDistance = buyEntry - buySL
    buyTP := buyEntry + (slDistance * tpMultiplier)
    
    if showEntry
        label.new(bar_index, buyEntry, "Entry: " + str.tostring(buyEntry, format.mintick), 
                  style=label.style_label_left, color=color.new(color.blue, 0), 
                  textcolor=color.white, size=size.small)
    
    if showTPSL
        label.new(bar_index, buyTP, "TP: " + str.tostring(buyTP, format.mintick), 
                  style=label.style_label_left, color=color.new(color.green, 0), 
                  textcolor=color.white, size=size.small)
        
        label.new(bar_index, buySL, "SL: " + str.tostring(buySL, format.mintick), 
                  style=label.style_label_left, color=color.new(color.red, 0), 
                  textcolor=color.white, size=size.small)

// Sell Signal (ORB Low Break or EMA Cross Below)
sellSignal = crossBelowORBLow or crossBelowEMA

if sellSignal
    sellEntry := close
    sellSL := sellEntry * (1 + slPercent / 100)
    slDistance = sellSL - sellEntry
    sellTP := sellEntry - (slDistance * tpMultiplier)
    
    if showEntry
        label.new(bar_index, sellEntry, "Entry: " + str.tostring(sellEntry, format.mintick), 
                  style=label.style_label_left, color=color.new(color.blue, 0), 
                  textcolor=color.white, size=size.small)
    
    if showTPSL
        label.new(bar_index, sellTP, "TP: " + str.tostring(sellTP, format.mintick), 
                  style=label.style_label_left, color=color.new(color.green, 0), 
                  textcolor=color.white, size=size.small)
        
        label.new(bar_index, sellSL, "SL: " + str.tostring(sellSL, format.mintick), 
                  style=label.style_label_left, color=color.new(color.red, 0), 
                  textcolor=color.white, size=size.small)

// ================= TABLE DISPLAY =================
var table trendTable = table.new(position.top_left, 2, 1, border_width=2)

if barstate.islast
    table.cell(trendTable, 0, 0, "EMA Trend:", text_color=color.white, bgcolor=color.new(color.gray, 30), text_size=size.normal)
    table.cell(trendTable, 1, 0, emaTrend, text_color=color.white, bgcolor=emaTrendColor, text_size=size.normal)

// ================= PLOTTING =================
plotshape(crossAboveORBHigh, title="ORB High Break", style=shape.triangleup, location=location.belowbar, color=buySignalColor, size=signalSizeConst, text="ORB↑", textcolor=color.white)
plotshape(crossBelowORBLow, title="ORB Low Break", style=shape.triangledown, location=location.abovebar, color=sellSignalColor, size=signalSizeConst, text="ORB↓", textcolor=color.white)

plotshape(crossAboveEMA, title="EMA9 Buy (Burmese)", style=shape.labelup, location=location.belowbar, color=buySignalColor, text="ဝယ်", textcolor=color.white, size=signalSizeConst)
plotshape(crossBelowEMA, title="EMA9 Sell (Burmese)", style=shape.labeldown, location=location.abovebar, color=sellSignalColor, text="ရောင်း", textcolor=color.white, size=signalSizeConst)

// ================= ALERT CONDITIONS =================
alertcondition(crossAboveORBHigh, "Cross Above ORB High", "Price crossed above ORB HIGH")
alertcondition(crossBelowORBLow,  "Cross Below ORB Low",  "Price crossed below ORB LOW")
alertcondition(crossAboveEMA, "EMA9 Cross Above", "ဝယ်")
alertcondition(crossBelowEMA, "EMA9 Cross Below", "ရောင်း")