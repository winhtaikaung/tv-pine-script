//@version=6
indicator("Zay Gwet Alert Enhanced EMA & Overal Market Signal", overlay=true, max_lines_count=500, max_labels_count=500)

// ================= INPUTS =================
openHour    = input.int(9, "Market Open Hour", minval=0, maxval=23)
openMin     = input.int(30, "Market Open Minute", minval=0, maxval=59)
orbMinutes  = input.int(15, "ORB Duration (minutes)", minval=1)
emaLen      = input.int(9, "EMA Length")

showORB     = input.bool(true, "Show ORB Lines")

// ================= COLOR SETTINGS =================
orbHighColor    = input.color(color.green, "ORB High Line Color")
orbLowColor     = input.color(color.red, "ORB Low Line Color")
buySignalColor  = input.color(color.green, "Buy Signal Color")
sellSignalColor = input.color(color.red, "Sell Signal Color")

// ================= SIZE SETTINGS =================
signalSizeConst = size.normal

// ================= EMA TABLE SETTINGS =================
showEMATable = input.bool(true, "Show EMA Analysis Table", group="EMA Table")

// ================= TIME / ORB =================
_y = year(time)
_m = month(time)
_d = dayofmonth(time)
start_time = timestamp(_y, _m, _d, openHour, openMin)
end_time   = start_time + orbMinutes * 60000

var float tempHigh = na
var float tempLow  = na
var float orbHigh  = na
var float orbLow   = na

var line orbHighLine = na
var line orbLowLine  = na

newDay = dayofmonth != dayofmonth[1]
if newDay
    tempHigh := na
    tempLow  := na
    orbHigh  := na
    orbLow   := na
    if not na(orbHighLine)
        line.delete(orbHighLine)
        orbHighLine := na
    if not na(orbLowLine)
        line.delete(orbLowLine)
        orbLowLine := na

sessionActive   = time >= start_time and time < end_time
sessionStartBar = sessionActive and not sessionActive[1]
sessionEndBar   = time >= end_time and time[1] < end_time

if sessionStartBar
    tempHigh := high
    tempLow  := low
else if sessionActive
    tempHigh := math.max(nz(tempHigh, high), high)
    tempLow  := math.min(nz(tempLow, low), low)

if sessionEndBar
    orbHigh := tempHigh
    orbLow  := tempLow
    if not na(orbHighLine)
        line.delete(orbHighLine)
    if not na(orbLowLine)
        line.delete(orbLowLine)
    orbHighLine := line.new(bar_index, orbHigh, bar_index + 1, orbHigh, extend=extend.right, color=orbHighColor, width=2)
    orbLowLine  := line.new(bar_index, orbLow,  bar_index + 1, orbLow,  extend=extend.right, color=orbLowColor, width=2)

// ================= SIGNAL LOGIC =================
hasOrb = not na(orbHigh) and not na(orbLow)

crossAboveORBHigh = ta.crossover(close, orbHigh) and not na(orbHigh)
crossBelowORBLow  = ta.crossunder(close, orbLow)  and not na(orbLow)

// ================= EMA CALCULATIONS =================
ema9    = ta.ema(close, emaLen)
ema20   = ta.ema(close, 20)
ema50   = ta.ema(close, 50)
ema100  = ta.ema(close, 100)
ema200  = ta.ema(close, 200)

crossAboveEMA  = ta.crossover(close, ema9)
crossBelowEMA  = ta.crossunder(close, ema9)

// ================= EMA CHANGE PERCENTAGES =================
ema9Change   = ((ema9 - ema9[1]) / ema9[1]) * 100
ema20Change  = ((ema20 - ema20[1]) / ema20[1]) * 100
ema50Change  = ((ema50 - ema50[1]) / ema50[1]) * 100
ema100Change = ((ema100 - ema100[1]) / ema100[1]) * 100
ema200Change = ((ema200 - ema200[1]) / ema200[1]) * 100

// ================= EMA STRENGTH CLASSIFICATION =================
// Function to classify individual EMA strength
getEMAStrength(priceAbove, emaChange) =>
    if priceAbove
        if emaChange > 0.5
            "Strong ↑"
        else if emaChange > 0
            "Bullish ↑"
        else
            "Weak ↑"
    else
        if emaChange < -0.5
            "Strong ↓"
        else if emaChange < 0
            "Bearish ↓"
        else
            "Weak ↓"

// Get strength color
getStrengthColor(strength) =>
    if str.contains(strength, "Strong ↑")
        color.new(color.green, 0)
    else if str.contains(strength, "Bullish ↑")
        color.new(color.lime, 30)
    else if str.contains(strength, "Weak ↑")
        color.new(color.green, 60)
    else if str.contains(strength, "Strong ↓")
        color.new(color.red, 0)
    else if str.contains(strength, "Bearish ↓")
        color.new(color.orange, 30)
    else
        color.new(color.red, 60)

// Calculate individual EMA strengths
priceAboveEMA9   = close > ema9
priceAboveEMA20  = close > ema20
priceAboveEMA50  = close > ema50
priceAboveEMA100 = close > ema100
priceAboveEMA200 = close > ema200

ema9Strength   = getEMAStrength(priceAboveEMA9, ema9Change)
ema20Strength  = getEMAStrength(priceAboveEMA20, ema20Change)
ema50Strength  = getEMAStrength(priceAboveEMA50, ema50Change)
ema100Strength = getEMAStrength(priceAboveEMA100, ema100Change)
ema200Strength = getEMAStrength(priceAboveEMA200, ema200Change)

// ================= OVERALL TREND ANALYSIS =================
bullishCount = (priceAboveEMA9 ? 1 : 0) + (priceAboveEMA20 ? 1 : 0) + (priceAboveEMA50 ? 1 : 0) + (priceAboveEMA100 ? 1 : 0) + (priceAboveEMA200 ? 1 : 0)

emaTrend = bullishCount == 5 ? "Strong Bullish" : 
           bullishCount == 4 ? "Bullish" :
           bullishCount == 3 ? "Mixed" :
           bullishCount == 2 ? "Mixed" :
           bullishCount == 1 ? "Bearish" : "Strong Bearish"

emaTrendColor = bullishCount >= 4 ? color.new(color.green, 0) :              bullishCount == 3 or bullishCount == 2 ? color.new(color.orange, 0) :               color.new(color.red, 0)

// ================= OVERALL EMA STRENGTH CALCULATION =================
// Calculate average change across all EMAs
avgEMAChange = (ema9Change + ema20Change + ema50Change + ema100Change + ema200Change) / 5

// Calculate strength score (0-100)
strengthScore = 0.0

// Add points for price position relative to EMAs
strengthScore := strengthScore + (priceAboveEMA9 ? 20 : -20)
strengthScore := strengthScore + (priceAboveEMA20 ? 15 : -15)
strengthScore := strengthScore + (priceAboveEMA50 ? 15 : -15)
strengthScore := strengthScore + (priceAboveEMA100 ? 10 : -10)
strengthScore := strengthScore + (priceAboveEMA200 ? 10 : -10)

// Add points for EMA momentum
strengthScore := strengthScore + (avgEMAChange * 10)

// Normalize to 0-100 range
strengthScore := math.max(-100, math.min(100, strengthScore))

// Classify overall strength
overallStrength = ""
overallStrengthColor = color.gray

if strengthScore >= 60
    overallStrength := "Very Strong ↑↑"
    overallStrengthColor := color.new(color.green, 0)
else if strengthScore >= 30
    overallStrength := "Strong ↑"
    overallStrengthColor := color.new(color.lime, 20)
else if strengthScore >= 10
    overallStrength := "Bullish ↑"
    overallStrengthColor := color.new(color.green, 50)
else if strengthScore > -10
    overallStrength := "Neutral →"
    overallStrengthColor := color.new(color.gray, 30)
else if strengthScore > -30
    overallStrength := "Bearish ↓"
    overallStrengthColor := color.new(color.red, 50)
else if strengthScore > -60
    overallStrength := "Strong ↓"
    overallStrengthColor := color.new(color.orange, 20)
else
    overallStrength := "Very Strong ↓↓"
    overallStrengthColor := color.new(color.red, 0)

// ================= SIGNAL STRENGTH CLASSIFICATION =================
// Determine signal strength
signalStrength = ""
signalColor = color.gray

if bullishCount >= 4
    if avgEMAChange > 0.3
        signalStrength := "High"
        signalColor := color.new(color.green, 0)
    else if avgEMAChange > 0.1
        signalStrength := "Medium"
        signalColor := color.new(color.yellow, 0)
    else
        signalStrength := "Low"
        signalColor := color.new(color.orange, 30)
else if bullishCount <= 1
    if avgEMAChange < -0.3
        signalStrength := "High"
        signalColor := color.new(color.red, 0)
    else if avgEMAChange < -0.1
        signalStrength := "Medium"
        signalColor := color.new(color.orange, 0)
    else
        signalStrength := "Low"
        signalColor := color.new(color.orange, 30)
else
    signalStrength := "Neutral"
    signalColor := color.new(color.gray, 30)

// ================= EMA TREND TABLE (TOP LEFT) =================
var table trendTable = table.new(position.top_left, 2, 1, border_width=2)

if barstate.islast
    table.cell(trendTable, 0, 0, "EMA Trend:", text_color=color.white, bgcolor=color.new(color.gray, 30), text_size=size.normal)
    table.cell(trendTable, 1, 0, emaTrend, text_color=color.white, bgcolor=emaTrendColor, text_size=size.normal)

// ================= EMA ANALYSIS TABLE (TOP RIGHT) =================
var table emaTable = table.new(position.top_right, 3, 10, border_width=1)

if barstate.islast and showEMATable
    // Overall Strength Header (Row 0)
    table.cell(emaTable, 0, 0, "Overall Strength:", text_color=color.white, bgcolor=color.new(color.blue, 10), text_size=size.normal, text_halign=text.align_left)
    table.cell(emaTable, 1, 0, overallStrength, text_color=color.white, bgcolor=overallStrengthColor, text_size=size.normal, text_halign=text.align_center)
    table.cell(emaTable, 2, 0, str.tostring(strengthScore, "#") + "/100", text_color=color.white, bgcolor=color.new(color.gray, 60), text_size=size.normal, text_halign=text.align_center)
    
    // Separator
    table.cell(emaTable, 0, 1, "───────", text_color=color.gray, bgcolor=color.new(color.black, 90), text_size=size.small, text_halign=text.align_center)
    table.cell(emaTable, 1, 1, "───────", text_color=color.gray, bgcolor=color.new(color.black, 90), text_size=size.small, text_halign=text.align_center)
    table.cell(emaTable, 2, 1, "───────", text_color=color.gray, bgcolor=color.new(color.black, 90), text_size=size.small, text_halign=text.align_center)
    
    // Header Row (Row 2)
    table.cell(emaTable, 0, 2, "EMA", text_color=color.white, bgcolor=color.new(color.blue, 20), text_size=size.small, text_halign=text.align_center)
    table.cell(emaTable, 1, 2, "Change %", text_color=color.white, bgcolor=color.new(color.blue, 20), text_size=size.small, text_halign=text.align_center)
    table.cell(emaTable, 2, 2, "Strength", text_color=color.white, bgcolor=color.new(color.blue, 20), text_size=size.small, text_halign=text.align_center)
    
    // EMA 9 Row
    table.cell(emaTable, 0, 3, "EMA 9", text_color=color.white, bgcolor=color.new(color.gray, 50), text_size=size.small)
    table.cell(emaTable, 1, 3, str.tostring(ema9Change, "#.##") + "%", 
               text_color=ema9Change >= 0 ? color.lime : color.red, 
               bgcolor=color.new(color.gray, 70), text_size=size.small, text_halign=text.align_right)
    table.cell(emaTable, 2, 3, ema9Strength, text_color=color.white, bgcolor=getStrengthColor(ema9Strength), text_size=size.small, text_halign=text.align_center)
    
    // EMA 20 Row
    table.cell(emaTable, 0, 4, "EMA 20", text_color=color.white, bgcolor=color.new(color.gray, 50), text_size=size.small)
    table.cell(emaTable, 1, 4, str.tostring(ema20Change, "#.##") + "%", 
               text_color=ema20Change >= 0 ? color.lime : color.red, 
               bgcolor=color.new(color.gray, 70), text_size=size.small, text_halign=text.align_right)
    table.cell(emaTable, 2, 4, ema20Strength, text_color=color.white, bgcolor=getStrengthColor(ema20Strength), text_size=size.small, text_halign=text.align_center)
    
    // EMA 50 Row
    table.cell(emaTable, 0, 5, "EMA 50", text_color=color.white, bgcolor=color.new(color.gray, 50), text_size=size.small)
    table.cell(emaTable, 1, 5, str.tostring(ema50Change, "#.##") + "%", 
               text_color=ema50Change >= 0 ? color.lime : color.red, 
               bgcolor=color.new(color.gray, 70), text_size=size.small, text_halign=text.align_right)
    table.cell(emaTable, 2, 5, ema50Strength, text_color=color.white, bgcolor=getStrengthColor(ema50Strength), text_size=size.small, text_halign=text.align_center)
    
    // EMA 100 Row
    table.cell(emaTable, 0, 6, "EMA 100", text_color=color.white, bgcolor=color.new(color.gray, 50), text_size=size.small)
    table.cell(emaTable, 1, 6, str.tostring(ema100Change, "#.##") + "%", 
               text_color=ema100Change >= 0 ? color.lime : color.red, 
               bgcolor=color.new(color.gray, 70), text_size=size.small, text_halign=text.align_right)
    table.cell(emaTable, 2, 6, ema100Strength, text_color=color.white, bgcolor=getStrengthColor(ema100Strength), text_size=size.small, text_halign=text.align_center)
    
    // EMA 200 Row
    table.cell(emaTable, 0, 7, "EMA 200", text_color=color.white, bgcolor=color.new(color.gray, 50), text_size=size.small)
    table.cell(emaTable, 1, 7, str.tostring(ema200Change, "#.##") + "%", 
               text_color=ema200Change >= 0 ? color.lime : color.red, 
               bgcolor=color.new(color.gray, 70), text_size=size.small, text_halign=text.align_right)
    table.cell(emaTable, 2, 7, ema200Strength, text_color=color.white, bgcolor=getStrengthColor(ema200Strength), text_size=size.small, text_halign=text.align_center)
    
    // Separator
    table.cell(emaTable, 0, 8, "───────", text_color=color.gray, bgcolor=color.new(color.black, 90), text_size=size.small, text_halign=text.align_center)
    table.cell(emaTable, 1, 8, "───────", text_color=color.gray, bgcolor=color.new(color.black, 90), text_size=size.small, text_halign=text.align_center)
    table.cell(emaTable, 2, 8, "───────", text_color=color.gray, bgcolor=color.new(color.black, 90), text_size=size.small, text_halign=text.align_center)
    
    // Signal Strength Row
    table.cell(emaTable, 0, 9, "Signal:", text_color=color.white, bgcolor=color.new(color.gray, 50), text_size=size.small)
    table.cell(emaTable, 1, 9, signalStrength, text_color=color.white, bgcolor=signalColor, text_size=size.small, text_halign=text.align_center)
    table.cell(emaTable, 2, 9, str.tostring(avgEMAChange, "#.##") + "%", 
               text_color=avgEMAChange >= 0 ? color.lime : color.red, 
               bgcolor=color.new(color.gray, 70), text_size=size.small, text_halign=text.align_right)

// ================= PLOTTING =================
plotshape(crossAboveORBHigh, title="ORB High Break", style=shape.triangleup, location=location.belowbar, color=buySignalColor, size=signalSizeConst, text="ORB↑", textcolor=color.white)
plotshape(crossBelowORBLow, title="ORB Low Break", style=shape.triangledown, location=location.abovebar, color=sellSignalColor, size=signalSizeConst, text="ORB↓", textcolor=color.white)

plotshape(crossAboveEMA, title="EMA9 Buy (Burmese)", style=shape.labelup, location=location.belowbar, color=buySignalColor, text="ဝယ်", textcolor=color.white, size=signalSizeConst)
plotshape(crossBelowEMA, title="EMA9 Sell (Burmese)", style=shape.labeldown, location=location.abovebar, color=sellSignalColor, text="ရောင်း", textcolor=color.white, size=signalSizeConst)

// ================= ALERT CONDITIONS =================
alertcondition(crossAboveORBHigh, "Cross Above ORB High", "Price crossed above ORB HIGH")
alertcondition(crossBelowORBLow,  "Cross Below ORB Low",  "Price crossed below ORB LOW")
alertcondition(crossAboveEMA, "EMA9 Cross Above", "ဝယ်")
alertcondition(crossBelowEMA, "EMA9 Cross Below", "ရောင်း")